<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>Исток — коттеджный поселок</title>
  <meta name="description" content="Коттеджный поселок Исток — природа, пруды, участки, инфраструктура. Узнайте о расположении, генплане, ценах и запишитесь на просмотр." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* CSS Variables */
    :root {
      /* Warm color palette */
      --bg: #f8f0e3;
      --card: #ffffff;
      --muted: #333333;
      --text: #000000;
      --accent: #906a41;
      --accent-2: #d4a574;
      --border: #e8d5c4;
      --input-bg: #f5ede1;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* Layout */
    .cottage-container {
      width: min(1100px, 92%);
      margin: 0 auto;
    }

    /* Buttons */
    .cottage-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.9rem 1.2rem;
      border-radius: 14px;
      background: linear-gradient(180deg, #906a41, #7a5a37);
      border: 1px solid var(--border);
      color: #f8f0e3;
      font-weight: 600;
      transition: transform 0.08s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 12px rgba(144, 106, 65, 0.2);
      text-decoration: none;
      cursor: pointer;
    }

    .cottage-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(144, 106, 65, 0.3);
    }

    .cottage-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .cottage-btn--accent {
      background: linear-gradient(180deg, #906a41, #7a5a37);
      color: #f8f0e3;
    }

    /* Navigation Tags */
    .cottage-tag {
      display: inline-block;
      padding: 0.35rem 0.7rem;
      border: 1px solid var(--accent);
      border-radius: 999px;
      color: #f8f0e3;
      background: linear-gradient(180deg, #906a41, #7a5a37);
      font-size: 0.85rem;
      text-decoration: none;
      transition: transform 0.08s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 8px rgba(144, 106, 65, 0.2);
    }

    .cottage-tag:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(144, 106, 65, 0.3);
    }

    /* Navigation */
    .cottage-nav {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(248, 240, 227, 0.9);
      border-bottom: 1px solid var(--border);
    }

    .cottage-nav__row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem 0;
    }

    .cottage-brand {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.3px;
      color: var(--text);
      text-decoration: none;
    }

.cottage-brand .logo {
  background: none !important; /* убираем прямоугольник */
  box-shadow: none !important; /* убираем тень */
  width: 34px;
  height: 34px;
  border-radius: 0; /* если не нужен скругленный фон */
}

    /* Hero Section */
    .cottage-hero {
      position: relative;
      padding: 7rem 0 5rem;
      overflow: hidden;
    }

    .cottage-hero::before {
      content: "";
      position: absolute;
      inset: -10% -20% auto -20%;
      height: 120%;
      background: radial-gradient(800px 400px at 70% 10%, rgba(212, 165, 116, 0.14), transparent 60%),
                  radial-gradient(700px 380px at 10% 30%, rgba(144, 106, 65, 0.16), transparent 60%);
      pointer-events: none;
    }

    .cottage-hero__grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 2rem;
      align-items: center;
    }

    .cottage-h1 {
      font-size: clamp(2rem, 4.2vw, 3.4rem);
      line-height: 1.05;
      letter-spacing: 0.2px;
      margin: 0.6rem 0 1.2rem;
      color: var(--text);
    }

    .cottage-lead {
      color: var(--text);
      font-size: clamp(1rem, 1.4vw, 1.15rem);
      opacity: 0.95;
    }

    .cottage-hero__media {
      position: relative;
      aspect-ratio: 4/3;
      border-radius: 20px;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: 0 20px 40px rgba(144, 106, 65, 0.15);
    }

    .cottage-hero__media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: saturate(105%);
    }

    /* Sections */
    .cottage-section {
      padding: 4.5rem 0;
      border-top: 1px solid var(--border);
    }

    .cottage-section h2 {
      font-size: clamp(1.4rem, 3vw, 2.1rem);
      margin: 0 0 1rem;
      color: var(--text);
    }

    .cottage-section h3 {
      font-size: clamp(1.2rem, 2.5vw, 1.8rem);
      margin: 0 0 0.8rem;
      color: var(--text);
    }

    /* Features */
    .cottage-features {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .cottage-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 1.2rem;
      box-shadow: 0 4px 12px rgba(144, 106, 65, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .cottage-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(144, 106, 65, 0.15);
    }

    .cottage-card h3 {
      margin: 0.4rem 0 0.3rem;
      font-size: 1.05rem;
      color: var(--text);
    }

    /* Gallery */
    .cottage-gallery {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0.6rem;
    }

    .cottage-gallery img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    /* Master Plan */
    .master-plan-wrapper {
      background: var(--bg);
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      border-radius: 20px;
      border: 1px solid var(--border);
    }

    .master-plan-controls {
      margin: 10px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .master-plan-controls select, 
    .master-plan-controls input, 
    .master-plan-controls button {
      padding: 6px 8px;
      font-size: 14px;
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    .master-plan-controls button {
      background: linear-gradient(180deg, #906a41, #7a5a37);
      color: #f8f0e3;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 8px rgba(144, 106, 65, 0.2);
      font-weight: 600;
    }

    .master-plan-controls button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(144, 106, 65, 0.3);
    }

    .master-plan-container {
      position: relative;
      max-width: 100vw;
      max-height: 80vh;
      overflow: auto;
      border: 1px solid var(--border);
      background: var(--card);
      width: 100%;
      max-width: 1200px;
      height: 600px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(144, 106, 65, 0.08);
    }

    .master-plan-img {
      display: block;
      width: 100%;
      height: auto;
      user-select: none;
      pointer-events: none;
    }

    .master-plan-svg {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    .master-plan-svg polygon {
      pointer-events: all;
      cursor: pointer;
      stroke: #333;
      stroke-width: 1;
      transition: opacity 0.3s;
      outline: none;
    }

    .master-plan-svg polygon:hover {
      stroke-width: 3;
      stroke: orange;
    }

    .master-plan-svg polygon:focus {
      outline: none;
    }

    .status-Свободен { fill: rgba(144,238,144,0.5); }
    .status-Бронь { fill: rgba(255,255,0,0.5); }
    .status-Продан { fill: rgba(255,0,0,0.5); }

    .master-plan-tooltip {
      position: absolute;
      background: var(--card);
      border: 1px solid var(--border);
      padding: 8px 12px;
      font-size: 14px;
      pointer-events: none;
      display: none;
      z-index: 10;
      max-width: 90vw;
      word-wrap: break-word;
      box-shadow: 0 4px 12px rgba(144, 106, 65, 0.15);
      border-radius: 8px;
      box-sizing: border-box;
      color: var(--text);
    }

    .master-plan-legend {
      margin-top: 20px;
      display: flex;
      gap: 20px;
      font-size: 16px;
      user-select: none;
      justify-content: center;
      width: 100%;
      max-width: 1200px;
      background-color: var(--card);
      padding: 12px 20px;
      border-radius: 12px;
      box-sizing: border-box;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(144, 106, 65, 0.05);
      color: var(--text);
    }

    .master-plan-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .master-plan-legend-color {
      width: 22px;
      height: 22px;
      border-radius: 3px;
    }

    .legend-Свободен { background: rgba(144,238,144,0.5); }
    .legend-Бронь { background: rgba(255,255,0,0.5); }
    .legend-Продан { background: rgba(255,0,0,0.5); }

    /* Lots */
    .cottage-lots {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .cottage-lot {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1rem;
      background: var(--card);
    }

    .cottage-lot .status {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status--free {
      color: #059669;
    }

    .status--booked {
      color: #d97706;
    }

    .status--sold {
      color: #dc2626;
    }

    /* Houses */
    .cottage-houses {
      display: grid;
      gap: 2rem;
    }

    .cottage-house-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(144, 106, 65, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .cottage-house-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(144, 106, 65, 0.15);
    }

    .cottage-house-gallery {
      display: flex;
      gap: 0.8rem;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding-bottom: 0.5rem;
    }

    .cottage-house-gallery::-webkit-scrollbar {
      height: 4px;
    }

    .cottage-house-gallery::-webkit-scrollbar-track {
      background: var(--border);
      border-radius: 2px;
    }

    .cottage-house-gallery::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 2px;
    }

    .cottage-house-gallery img {
      flex-shrink: 0;
      width: 200px;
      height: 150px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    /* Location */
    .cottage-location__wrap {
      display: grid;
      grid-template-columns: 0.9fr 1.1fr;
      gap: 1rem;
    }

    .cottage-map {
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      min-height: 320px;
      background: var(--input-bg);
    }

    /* Forms */
    .cottage-form {
      display: grid;
      gap: 0.8rem;
    }

    .cottage-input,
    .cottage-textarea {
      width: 100%;
      padding: 0.9rem 1rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      transition: border-color 0.2s ease;
    }

    .cottage-input:focus,
    .cottage-textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(144, 106, 65, 0.1);
    }

    .cottage-textarea {
      min-height: 120px;
      resize: vertical;
    }

    /* Phone Button */
    .phone-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      left: auto;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #906a41, #7a5a37);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(144, 106, 65, 0.3);
      cursor: pointer;
      z-index: 1000;
      text-decoration: none;
      color: #f8f0e3;
      font-size: 24px;
      transition: all 0.3s ease;
      animation: phoneFloat 3s ease-in-out infinite;
    }

    .phone-button:hover {
      transform: scale(1.1) translateY(-2px);
      box-shadow: 0 8px 30px rgba(144, 106, 65, 0.4);
      background: linear-gradient(135deg, #a57649, #8a6040);
    }

    .phone-button:active {
      transform: scale(0.95);
      transition: transform 0.1s ease;
    }

    .phone-button::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(144, 106, 65, 0.3);
      animation: phoneRipple 2s infinite;
    }

    @keyframes phoneFloat {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    @keyframes phoneRipple {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(1.5);
        opacity: 0;
      }
    }

    /* Cookie Banner */
    .cookie-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      padding: 1rem;
      box-shadow: 0 -4px 20px rgba(144, 106, 65, 0.1);
      z-index: 999;
      font-size: 0.9rem;
      color: var(--text);
      display: none;
    }

    .cookie-banner.show {
      display: block;
    }

    .cookie-banner-content {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .cookie-banner button {
      background: var(--accent);
      color: #f8f0e3;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .cookie-banner button:hover {
      background: #7a5a37;
    }

    .cookie-banner a {
      color: var(--accent);
      text-decoration: underline;
    }

    /* Footer */
    .cottage-footer {
      padding: 3rem 0;
      border-top: 1px solid var(--border);
      color: var(--muted);
    }

    /* Responsive */
    @media (max-width: 920px) {
      .cottage-nav__row {
        flex-direction: column;
        gap: 1rem;
        align-items: center;
        text-align: center;
      }

      .cottage-nav__row nav {
        flex-wrap: wrap;
        justify-content: center;
      }

      .cottage-hero__grid,
      .cottage-location__wrap {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .cottage-features {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .cottage-gallery {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .cottage-lots {
        grid-template-columns: repeat(2, 1fr);
      }

      .cottage-house-card > div {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
      }

      .cottage-house-gallery {
        order: -1;
      }

      .cottage-section {
        padding: 3rem 0;
      }

      .cottage-hero {
        padding: 5rem 0 3rem;
      }

      .master-plan-container {
        height: 400px;
      }

      .cottage-footer > div {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
      }
    }

    @media (max-width: 560px) {
      .cottage-container {
        width: min(1100px, 95%);
      }

      .cottage-nav {
        padding: 0 1rem;
      }

      .cottage-nav__row {
        padding: 1rem 0;
      }

      .cottage-brand {
        font-size: 0.9rem;
      }

      .cottage-nav__row nav {
        gap: 0.5rem;
      }

      .cottage-tag {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
      }

      .cottage-hero {
        padding: 4rem 0 2.5rem;
      }

      .cottage-h1 {
        font-size: 1.8rem;
        line-height: 1.1;
      }

      .cottage-lead {
        font-size: 1rem;
      }

      .cottage-btn {
        padding: 0.8rem 1rem;
        font-size: 0.9rem;
      }

      .cottage-section {
        padding: 2.5rem 0;
      }

      .cottage-section h2 {
        font-size: 1.6rem;
        margin-bottom: 0.8rem;
      }

      .cottage-section h3 {
        font-size: 1.3rem;
      }

      .cottage-features {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }

      .cottage-card {
        padding: 1rem;
      }
      
      .cottage-gallery {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
      }

      .cottage-gallery img {
        height: 120px;
      }
      
      .cottage-lots {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }

      .cottage-lot {
        padding: 0.8rem;
      }

      .cottage-house-card {
        padding: 1rem;
      }

      .cottage-house-gallery img {
        width: 160px;
        height: 120px;
      }

      .cottage-form > div {
        grid-template-columns: 1fr !important;
      }

      .cottage-input,
      .cottage-textarea {
        padding: 0.8rem;
        font-size: 16px;
      }

      .master-plan-wrapper {
        padding: 15px;
      }

      .master-plan-controls {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }

      .master-plan-controls select, 
      .master-plan-controls input, 
      .master-plan-controls button {
        font-size: 16px;
        padding: 12px;
        width: 100%;
        box-sizing: border-box;
        border-radius: 8px;
      }

      .master-plan-container {
        height: 300px;
      }

      .master-plan-legend {
        flex-direction: column;
        gap: 15px;
        text-align: center;
        font-size: 14px;
      }

      .master-plan-legend-item {
        justify-content: center;
      }

      .cottage-hero__media {
        aspect-ratio: 3/2;
      }

      .cottage-hero > div div:first-child {
        text-align: center;
      }

      .cottage-hero > div div:first-child > div {
        justify-content: center;
      }
    }

    @media (max-width: 400px) {
      .cottage-container {
        width: min(1100px, 92%);
      }

      .cottage-h1 {
        font-size: 1.6rem;
      }

      .cottage-section {
        padding: 2rem 0;
      }

      .cottage-section h2 {
        font-size: 1.4rem;
      }

      .cottage-btn {
        padding: 0.7rem 0.9rem;
        font-size: 0.85rem;
      }

      .cottage-house-gallery img {
        width: 140px;
        height: 100px;
      }

      .master-plan-container {
        height: 250px;
      }

      .cottage-gallery img {
        height: 100px;
      }

      .phone-button {
        width: 50px;
        height: 50px;
        font-size: 20px;
        bottom: 15px;
        right: 15px;
        left: auto;
      }

      .cookie-banner-content {
        flex-direction: column;
        text-align: center;
        gap: 0.8rem;
      }

      .cottage-footer .cottage-container > div:first-child {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
      }

      .cottage-footer .cottage-container > div:last-child {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
    }
  
.cottage-gallery img {
  transition: transform 0.3s ease;
  cursor: pointer;
}
.cottage-gallery img:hover {
  transform: scale(1.05);
}


.cottage-house-gallery img {
  transition: transform 0.3s ease;
  cursor: pointer;
}
.cottage-house-gallery img:hover {
  transform: scale(1.05);
}



/* === Mobile header (burger) === */
.burger{
  display:none;
  flex-direction:column;
  gap:4px;
  cursor:pointer;
  z-index:1001;
}
.burger span{
  width:24px;
  height:3px;
  background:#906a41;
  border-radius:2px;
  transition:transform .3s, opacity .3s;
}

/* overlay behind the side panel */
.menu-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  opacity:0;
  pointer-events:none;
  transition:opacity .25s ease;
  z-index:1100;
}
.menu-overlay.show{
  opacity:1;
  pointer-events:auto;
}

/* side panel */
.mobile-menu{
  position:fixed;
  top:0;
  right:-100%;
  width:min(78vw,360px);
  height:100vh;
  background:rgba(248,240,227,.97);
  box-shadow:-6px 0 24px rgba(0,0,0,.2);
  padding:2rem 1.25rem;
  display:flex;
  flex-direction:column;
  gap:.75rem;
  transition:right .3s ease;
  z-index:1200;
}
.mobile-menu.show{ right:0; }
.mobile-menu a{
  font-size:1.05rem;
  padding:.6rem 0;
  border-bottom:1px solid var(--border);
  text-decoration:none;
  color:var(--text);
}

body.no-scroll{ overflow:hidden; }

/* ensure desktop keeps original nav */
@media (max-width: 560px){
  .cottage-nav__row nav{ display:none !important; }
  .burger{ display:flex; }
}



/* === Mobile brand/title/burger alignment tweaks === */
@media (max-width: 560px) {
  .cottage-nav__row {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    justify-content: space-between !important;
    gap: 8px;
  }
  .cottage-brand {
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    margin-right: auto !important;
  }
  .cottage-brand .logo {
    width: 32px !important;
    height: 32px !important;
  }
  .cottage-brand span {
    display: none !important;
  }
  .cottage-brand::after {
    content: "Исток";
    color: #906a41;
    font-weight: 700;
    font-size: 1.5rem;
    display: inline-block;
    height: 24px;
    line-height: 24px;
  }
  .burger {
    margin-left: 12px;
    height: 24px;
    display: flex;
    align-items: center;
  }
  .burger span {
    width: 24px;
    height: 3px;
  }
  .cottage-nav__row nav {
    display: none !important;
  }
}



/* === Extra Mobile Adjustments === */
@media (max-width: 560px) {

  /* 1) Make filter buttons same height as inputs */
  .master-plan-controls button {
    padding: 12px !important;
    font-size: 16px !important;
    height: 44px !important;
    flex: 1 1 auto;
  }

  /* 2) Enable zoom/pan for master plan */
  .master-plan-container {
    overflow: auto !important;
    touch-action: pan-x pan-y;
  }
  .master-plan-img {
    max-width: none !important;
    width: 1200px !important; /* allow scroll/zoom */
  }
  .master-plan-svg {
    width: 1200px !important;
    height: auto !important;
  }

  /* 3) Remove white space below genplan image */
  #map-container {
    margin-bottom: 0 !important;
  }

  /* 4) Legend inline instead of column */
  .master-plan-legend {
    flex-direction: row !important;
    gap: 15px !important;
    justify-content: center !important;
    text-align: center;
  }

  /* 5) House blocks same width as container */
  .cottage-houses {
    width: 100% !important;
  }
  .cottage-house-card {
    max-width: 100% !important;
    margin: 0 auto !important;
  }
  .cottage-house-card > div {
    grid-template-columns: 1fr !important;
  }
  .cottage-house-card h3 {
    font-size: 1.2rem !important;
  }
  .cottage-house-card p {
    font-size: 0.95rem !important;
    line-height: 1.4 !important;
  }

  /* 6) Equal width for hero buttons */
  .cottage-hero .cottage-btn {
    flex: 1 1 auto !important;
    min-width: 140px;
    text-align: center;
    justify-content: center;
  }
  .cottage-hero div[style*="flex-wrap"] {
    width: 100% !important;
    display: flex !important;
  }
}


@media (max-width: 560px) {
  /* === Fix house blocks === */
  .cottage-house-gallery img {
    width: 100% !important;
    height: auto !important;
    max-width: 320px;
    margin: 0 auto;
  }
  .cottage-house-card {
    text-align: center;
  }

  /* === Genplan zoom toggle === */
  .master-plan-container {
    overflow: hidden;
  }
  
  .master-plan-container img {
    width: 100% !important;
  }
  

  /* === Equal filter buttons === */
  .master-plan-controls button {
    flex: 1;
    min-width: 45%;
    height: 48px !important;
    font-size: 16px !important;
    text-align: center;
  }
}


/* ==== GENPLAN: чистый вид без белых областей ==== */
.master-plan-container {
  position: relative !important;
  background: transparent !important;
  border: none !important;
  padding: 0 !important;
  margin: 0 auto !important;
  max-height: none !important;
  overflow: visible !important;
  line-height: 0 !important; /* убирает "хвост" у <img> */
}

.master-plan-img {
  display: block !important;
  width: 100% !important;
  height: auto !important;
  margin: 0 !important;
}

.master-plan-svg {
  position: absolute !important;
  top: 0; left: 0;
  width: 100% !important;
  height: auto !important;
  pointer-events: none; /* сами полигоны включат события */
}

.master-plan-svg polygon {
  pointer-events: all;
}

/* Кнопки фильтров — одинаковые по высоте и ширине */
.master-plan-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}
.master-plan-controls .cottage-btn {
  flex: 1 1 220px;
  min-height: 52px;
  text-align: center;
  justify-content: center;
  white-space: nowrap;
}

/* ==== FULLSCREEN VIEWER (панорама + zoom + pinch) ==== */
.genplan-viewer {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: rgba(0,0,0,.9);
  display: flex;
}
.genplan-viewer .gp-stage {
  position: absolute;
  inset: 0;
  overflow: hidden;
  touch-action: none; /* жесты только наши */
  cursor: grab;
}
.genplan-viewer .gp-image {
  position: absolute;
  top: 0; left: 0;
  transform-origin: 0 0;
  will-change: transform;
  user-select: none;
  -webkit-user-drag: none;
}
.genplan-viewer .gp-toolbar {
  position: absolute;
  top: 12px;
  right: 12px;
  z-index: 10000;
  display: flex;
  gap: 8px;
}
.genplan-viewer .gp-close {
  background: rgba(255,255,255,.12);
  border: 1px solid rgba(255,255,255,.25);
  backdrop-filter: blur(6px);
  color: #fff;
  border-radius: 10px;
  padding: 8px 12px;
  font-size: 18px;
  line-height: 1;
  cursor: pointer;
}
.genplan-viewer .gp-close:active { transform: scale(.98); }


/* ==== FIX tooltip overlap on genplan ==== */
.master-plan-container {
  line-height: normal !important; /* вернули нормальную высоту */
  position: relative !important; /* чтобы tooltip позиционировался корректно */
}

.master-plan-tooltip {
  position: absolute !important;
  z-index: 10000 !important; /* выше изображения */
  line-height: 1.4 !important; /* читаемый текст */
  white-space: normal !important;
}

.house-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

@media (min-width: 1024px) {
  .house-info {
    justify-content: flex-start;
    gap: 2rem;
  }
}

/* === Genplan Viewer: content wrapper + SVG overlay + tooltip (stronger selectors) === */
.genplan-viewer .gp-stage { position:absolute; inset:0; overflow:hidden; touch-action:none; cursor:grab; }
.genplan-viewer .gp-content { position:absolute; top:0; left:0; transform-origin:0 0; will-change:transform; }
.genplan-viewer .gp-img    { position:absolute; top:0; left:0; user-select:none; -webkit-user-drag:none; pointer-events:none; }
.genplan-viewer .gp-svg    { position:absolute; top:0; left:0; pointer-events:none; }
.genplan-viewer .gp-svg polygon { pointer-events:all; cursor:pointer; stroke:#333; stroke-width:1; outline:none; }
.genplan-viewer .gp-svg polygon:hover { stroke-width:3; stroke:orange; }
.genplan-viewer .gp-tooltip {
  position:absolute; background:#fff; color:#000;
  border:1px solid rgba(0,0,0,.15); padding:8px 10px; border-radius:8px;
  box-shadow:0 6px 24px rgba(0,0,0,.25); display:none; z-index:10001; max-width:92vw;
}
.genplan-viewer .gp-toolbar { position:absolute; top:12px; right:12px; z-index:10002; display:flex; gap:8px; }
.genplan-viewer .gp-btn {
  background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25);
  color:#fff; border-radius:10px; padding:8px 12px; font-size:16px; line-height:1; cursor:pointer; backdrop-filter:blur(6px);
}
.genplan-viewer .gp-btn:active { transform:scale(.98); }
.genplan-viewer .gp-overlay { position:fixed; inset:0; background:rgba(0,0,0,.9); }


/* === Fullscreen open hotspot to guarantee click === */
#map-container { position: relative; }
#map-container .gp-open-hotspot {
  position:absolute; inset:0; background:transparent; border:0; padding:0; margin:0;
  cursor: zoom-in; z-index:1; pointer-events:none; /* allow interactions with SVG/polygons under it */
}
#map-container img, #map-container svg { display:block; }


/* === Inline genplan tooltip === */
#map-container { position:relative; }
#map-container .gp-tooltip {
  position:absolute; background:#fff; color:#000;
  border:1px solid rgba(0,0,0,.15); padding:6px 8px; border-radius:6px;
  box-shadow:0 4px 12px rgba(0,0,0,.2); display:none; z-index:1000; font-size:13px;
  max-width:90%;
}
#map-container .gp-svg { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:6; }
#map-container .gp-svg polygon { pointer-events:all; cursor:pointer; stroke:#333; stroke-width:1; fill:transparent; }
#map-container .gp-svg polygon:hover { stroke:orange; stroke-width:2; }


/* Mobile layout fix: remove extra whitespace under image, keep svg on top */
#map-container { display:inline-block; line-height:0; position:relative; }
#map-container img { display:block; width:100%; height:auto; max-width:100%; }
#map-container .gp-svg { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:6; }
#map-container .gp-open-hotspot { pointer-events:none; z-index:1; }


/* === User adjustments: header layout and house block tweaks === */
/* Mobile: center title, left-pin logo, burger right, single-line */
@media (max-width: 560px) {
  .cottage-nav__row { position: relative !important; justify-content: center !important; padding-left: 0 !important; padding-right: 0 !important; }
  /* ensure original pseudo-element on .cottage-brand does not duplicate the title */
  .cottage-brand::after { content: none !important; }
  .cottage-brand { position: absolute !important; left: 12px !important; top: 50% !important; transform: translateY(-50%) !important; display: flex !important; align-items: center !important; gap: 8px !important; margin: 0 !important; }
  .cottage-brand .logo { width: 48px !important; height: 48px !important; }
  .cottage-brand span { display: none !important; } /* hide inline span; show centered title instead */
  .cottage-nav__row::after { content: "Исток"; position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); font-weight: 700; color: #906a41; font-size: 1.25rem; pointer-events: none; white-space: nowrap; }
  .burger { position: absolute !important; right: 12px !important; top: 50% !important; transform: translateY(-50%) !important; margin-left: 0 !important; }
}

/* Desktop: larger logo, larger title, left aligned inside header container */
@media (min-width: 561px) {
  .cottage-brand .logo { width: 58px !important; height: 58px !important; }
  .cottage-brand span { font-size: 1.25rem !important; font-weight: 800 !important; margin-left: 8px !important; color: #906a41 !important; }
  .cottage-brand { gap: 12px !important; align-items: center !important; }
  /* keep brand at the left of the header container */
  .cottage-nav__row { justify-content: space-between !important; }
  .cottage-container.cottage-nav__row { padding-left: 0 !important; padding-right: 0 !important; }
}

/* House block: make area left and price right (symmetric) */
.cottage-house-card .house-meta-row,
.cottage-house-card [style*="display: flex; gap: 2rem; margin-bottom: 1rem; justify-content: space-between; align-items: center;"] {
  justify-content: space-between !important;
  align-items: center !important;
}

/* Extra safety: ensure logo does not get hidden by other selectors */
.cottage-brand .logo { display: inline-block !important; max-width: none !important; }

</style>

<!-- Ensure global access to plots regardless of whether they were declared with const/let -->
<script>
  try {
    if (typeof plots !== 'undefined' && !window.plots) {
      window.plots = plots;
    }
  } catch(e){ /* ignore */ }
</script>

<style>

/* === Second-pass fixes: make desktop logo flush-left, reduce title size, and prevent mobile overflow === */

/* Desktop: ensure brand is flush to the left edge of the header container and title is smaller */
@media (min-width: 561px) {
  /* reduce side paddings to allow brand to be at the very left of the header container */
  .cottage-nav__row, .cottage-header, .cottage-container { padding-left: 8px !important; padding-right: 8px !important; }
  /* make sure the brand sits at the left inside the header */
  .cottage-brand { position: relative !important; left: 0 !important; margin-left: 0 !important; padding-left: 0 !important; transform: none !important; display:flex !important; align-items:center !important; z-index: 5 !important; }
  .cottage-brand .logo { margin-left: 0 !important; margin-right: 8px !important; width: 56px !important; height: 56px !important; max-width: none !important; max-height: none !important; box-sizing: border-box !important; }
  /* make the title smaller and neater */
  .cottage-brand span { font-size: 1rem !important; line-height: 1 !important; font-weight: 700 !important; color: #906a41 !important; margin: 0 !important; padding: 0 !important; }
  /* ensure the nav row keeps spacing for other items */
  .cottage-nav__row { display: flex !important; align-items: center !important; justify-content: space-between !important; }
}

/* Mobile: prevent logo overflow, tighten header height and keep clean layout */
@media (max-width: 560px) {
  .cottage-nav__row { min-height: 56px !important; height: 56px !important; padding-left: 8px !important; padding-right: 8px !important; }
  .cottage-brand { position: absolute !important; left: 8px !important; top: 50% !important; transform: translateY(-50%) !important; display:flex !important; align-items:center !important; gap:8px !important; z-index: 6 !important; }
  /* constrain the logo so it never exceeds header height */
  .cottage-brand .logo { width: 44px !important; height: 44px !important; max-width: 44px !important; max-height: 44px !important; box-sizing: border-box !important; }
  /* slightly smaller centered title for mobile pseudo-element */
  .cottage-nav__row::after { font-size: 1.05rem !important; top: 50% !important; transform: translate(-50%,-50%) !important; white-space: nowrap; pointer-events: none; }
  .burger { right: 8px !important; top: 50% !important; transform: translateY(-50%) !important; z-index: 7 !important; }
}

/* House meta row: keep the area left and price right */
.cottage-house-card .house-meta-row { display: flex !important; justify-content: space-between !important; align-items: center !important; width: 100% !important; box-sizing: border-box !important; padding: 0 !important; }

/* Safety: ensure images in brand do not carry extra margins that push them away */
.cottage-brand img, .cottage-brand .logo { display: inline-block !important; margin: 0 !important; padding: 0 !important; }

</style>

<link rel="icon" type="image/png" href="logo_1.png">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

</head>
<body>
<!-- Navigation -->
<header class="cottage-nav">
  <div class="cottage-container cottage-nav__row" style="padding-left: 0; padding-right: 0; justify-content: space-between;">
    <a class="cottage-brand" href="#top" aria-label="Исток" style="margin-left: 0;">
      <img src="logo.png" alt="Логотип Исток" class="logo" 
           style="width:42px;height:42px;background:none;box-shadow:none;border-radius:0;">
      <span style="color:#906a41;">Исток — коттеджный поселок</span>
    </a>
    <div class="burger" id="burger" aria-label="Открыть меню" aria-expanded="false" aria-controls="mobileMenu"><span></span><span></span><span></span></div>
    <nav style="display: flex; gap: 0.8rem;">
      <a class="cottage-tag" href="#location">Расположение</a>
      <a class="cottage-tag" href="#plan">Генплан</a>
      <a class="cottage-tag" href="#lots">Участки</a>
      <a class="cottage-tag" href="#houses">Дома</a>
      <a class="cottage-tag" href="#contact">Заявка</a>
      <a class="cottage-tag" href="tel:+79859854352">📞 Позвонить</a>
      <a class="cottage-tag" href="https://t.me/village_istok" target="_blank">✈️ Telegram</a>
    </nav>
  </div>
</header>

<!-- Мобильное меню и оверлей -->
<div class="mobile-menu" id="mobileMenu" role="dialog" aria-modal="true">
  <a href="#location">Расположение</a>
  <a href="#plan">Генплан</a>
  <a href="#lots">Участки</a>
  <a href="#houses">Дома</a>
  <a href="#contact">Заявка</a>
  <a href="tel:+79859854352">📞 Позвонить</a>
  <a href="https://t.me/village_istok" target="_blank">✈️ Telegram</a>
</div>
<div class="menu-overlay" id="menuOverlay"></div>


  <main id="top">
    <!-- Hero Section -->
    <section class="cottage-hero">
      <div class="cottage-container cottage-hero__grid">
        <div>
          <span class="cottage-tag">Новый поселок у воды</span>
          <h1 class="cottage-h1">Жизнь на природе, среди лесов и прудов</h1>
          <p class="cottage-lead" style="color: var(--text);">
            Участки рядом с прудами и берёзовой рощей. Электричество и дороги, 
            общественные зоны и собственная философия «новой деревни» — для спокойной 
            жизни и дружного комьюнити.
          </p>
          <div style="display: flex; gap: 0.6rem; margin-top: 1.2rem; flex-wrap: wrap;">
            <a class="cottage-btn cottage-btn--accent" href="#contact">
              Записаться на просмотр
            </a>
            <a class="cottage-btn" href="#plan">
              Смотреть участки
            </a>
          </div>
          <div style="display: flex; flex-direction: column; gap: 0.3rem; margin-top: 1rem; color: var(--text); font-size: 0.95rem;"><span>⚡ 15 кВт</span><span>🛣️ Щебеночная дорога</span><span>🌊 Каскад водоемов</span><span>🏡 Общественные пространства</span></div>
        </div>
        <div class="cottage-hero__media" aria-label="Фото поселка">
          <img src="hero.jpeg" alt="Пейзаж с водой и полями" />
        </div>
      </div>
    </section>

    <!-- Features Section -->
    <section class="cottage-section">
      <div class="cottage-container">
        <h2>Почему «Исток»</h2>
        <p style="color: var(--text);">Коротко о самых важных преимуществах проекта.</p>
        <div class="cottage-features" style="margin-top: 1rem;">
          <article class="cottage-card">
            <div class="cottage-tag">Природа</div>
            <h3>Пруды и берёзовая роща</h3>
            <p style="color: var(--text);">
              Видовые участки, прогулочные тропы, места для рыбалки и пикников.
            </p>
          </article>
          <article class="cottage-card">
            <div class="cottage-tag">Инфраструктура</div>
            <h3>Коммуникации и дороги</h3>
            <p style="color: var(--text);">
              Электричество, подъездные пути и общественные пространства.
            </p>
          </article>
          <article class="cottage-card">
            <div class="cottage-tag">Сообщество</div>
            <h3>Новая деревня</h3>
            <p style="color: var(--text);">
              Соседские дворища и общие активности для жителей.
            </p>
          </article>
        </div>
      </div>
    </section>

    <!-- Location Section -->
<section id="location" class="cottage-section">
  <div class="cottage-container cottage-location__wrap">
    <div>
      <h2>Расположение и доступность</h2>
      <p style="color: var(--text);">
        Удобное расположение поселка обеспечивает лёгкий и быстрый доступ, сохраняя уединение и близость к природе
      </p>
      <ul style="color: var(--text); padding-left: 0; list-style: none;">
        <li style="margin-bottom: 0.5rem;">🚗 2 часа от МКАД (трасса М4 или М2), 1 час от Тулы</li>
        <li style="margin-bottom: 0.5rem;">🛒 Ближайшие магазины и фермерские продукты</li>
        <li style="margin-bottom: 0.5rem;">🏞️ Лес, водоемы и прогулочные тропы рядом</li>
        <li style="margin-bottom: 0.5rem;">🎓 Школа — в радиусе 10 км</li>
      </ul>
    </div>
    <div class="cottage-map" aria-label="Карта" style="width:100%;height:501px;">
      <script type="text/javascript" charset="utf-8" async
        src="https://api-maps.yandex.ru/services/constructor/1.0/js/?um=constructor%3A1a5756d586b332b5d397d93476f657849d857dce38a7917883b6c4649ff0cd9e&amp;width=100%25&amp;height=501&amp;lang=ru_RU&amp;scroll=true">
      
</script>
    </div>
  </div>
</section>

    <!-- Plan Section -->
<section id="plan" class="cottage-section">
  <div class="cottage-container">
    <h2>Генплан</h2>

    <div style="margin-top: 2rem; margin-bottom: 3rem;">
      <!-- Master Plan -->
      <div class="master-plan-wrapper">
        <div class="master-plan-controls">
          <!-- Inputs row -->
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:10px;">
            <input type="number" id="filter-num" placeholder="Номер участка" min="1" />
            <input type="number" id="filter-area-min" placeholder="Площадь от" min="0" step="0.01" />
            <input type="number" id="filter-area-max" placeholder="Площадь до" min="0" step="0.01" />
            <select id="filter-status">
              <option value="">Все статусы</option>
              <option value="Свободен">Свободен</option>
              <option value="Бронь">Бронь</option>
              <option value="Продан">Продан</option>
            </select>
          </div>

          <!-- Buttons row (centered) -->
          <div style="display:flex; justify-content:center; gap:20px; margin-top:10px;">
            <button class="cottage-btn" onclick="applyFilters()">Применить фильтры</button>
            <button class="cottage-btn" onclick="resetFilters()">Сбросить фильтры</button>
          </div>
        </div>

        <div id="map-container" class="master-plan-container">
          <img id="map-img" class="master-plan-img" src="genplan.jpg" alt="Генеральный план поселка" />
          <svg id="map-svg" class="master-plan-svg" width="1200" height="900" aria-label="План участков"></svg>
          <div id="tooltip" class="master-plan-tooltip" role="tooltip" aria-hidden="true"></div>
        </div>

        <div class="master-plan-legend" aria-label="Легенда статусов участков">
          <div class="master-plan-legend-item">
            <div class="master-plan-legend-color legend-Свободен"></div> 
            Свободен
          </div>
          <div class="master-plan-legend-item">
            <div class="master-plan-legend-color legend-Бронь"></div> 
            Бронь
          </div>
          <div class="master-plan-legend-item">
            <div class="master-plan-legend-color legend-Продан"></div> 
            Продан
          </div>
        </div>
      </div>
    </div>

    <div>
      <h3>Галерея поселка</h3>
      <p style="color: var(--text); margin-bottom: 1rem;">
        Визуализации домов и уличных перспектив.
      </p>
      <div class="cottage-gallery">
        <img src="gallery1.jpeg" alt="Фото 1" />
        <img src="gallery2.jpeg" alt="Фото 2" />
        <img src="gallery3.jpeg" alt="Фото 3" />
        <img src="gallery4.jpg" alt="Фото 4" />
        <img src="gallery5.jpg" alt="Фото 5" />
        <img src="gallery6.jpg" alt="Фото 6" />
      </div>
    </div>
  </div>
</section>

    <!-- Lots Section -->
    <section id="lots" class="cottage-section">
      <div class="cottage-container">
        <h2>Акция до конца лета</h2>
        <p style="color: var(--text);">Выберите подходящий участок для строительства дома.</p>
        <div class="cottage-lots" id="lots-container">
          <!-- Lots will be populated by JavaScript -->
        </div>
      </div>
    </section>

    <!-- Houses Section -->
    <section id="houses" class="cottage-section">
      <div class="cottage-container">
        <h2>Готовые проекты домов</h2>
        <p style="color: var(--text);">
          Выберите готовый проект дома или закажите индивидуальный. 
          Строительство под ключ с гарантией качества.
        </p>
        <div class="cottage-houses" style="margin-top: 2rem;" id="houses-container">
          <!-- Houses will be populated by JavaScript -->
        </div>
      </div>
    </section>

<section class="cottage-section">
  <div class="cottage-container" style="display:flex; flex-wrap:wrap; align-items:center; gap:2rem;">
    <div style="flex:1 1 300px; min-width:250px;">
      <h2>О поселке Исток</h2>
      <p style="color: var(--text); line-height:1.5;">
        Познакомьтесь с нашим коттеджным поселком через короткое видео. Увидьте природу, дома и инфраструктуру, чтобы принять решение о покупке участка или дома.
      </p>
      <ul style="color: var(--text); padding-left: 1.2rem; line-height:1.5;">
        <li>Природные холмы и пруды</li>
        <li>Готовые проекты домов</li>
        <li>Общественные зоны и безопасность</li>
      </ul>
    </div>

    <!-- Видео справа — ВАРИАНТ A: contain -->
    <div style="flex:1 1 480px; max-width:600px;">
      <div style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:12px; background:#000;">
        <video
          src="img/video.mp4"
          controls
          autoplay
          muted
          loop
          style="position:absolute; inset:0; width:100%; height:100%; border-radius:12px; object-fit:contain; background:#000;">
          Ваш браузер не поддерживает воспроизведение видео.
        </video>
      </div>
    </div>
  </div>
</section>

<section class="cottage-section">
  <div class="cottage-container">
    <div style="display:flex; flex-wrap:wrap; align-items:center; gap:1.5rem; background:#fefefe; padding:1.5rem; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.1); transition: transform 0.3s;">
      <img src="contact.jpg" alt="Фото менеджера" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid var(--accent);">
      <div style="flex:1 1 250px; min-width:200px;">
        <h3 style="margin:0 0 0.5rem;">Ваш менеджер</h3>
        <p style="margin:0.2rem 0; color: var(--text); font-weight:500;">Артем поможет вам с выбором недвижимости в коттеджном посёлке «Исток»</p>
        <p style="margin:0.2rem 0;">📞 <a href="tel:+79859854352" style="color:var(--accent); text-decoration:underline;">+7 (985) 985-43-52</a></p>
        <p style="margin:0.2rem 0;">💬 <a href="https://t.me/village_istok" target="_blank" style="color:var(--accent); text-decoration:underline;">@village_istok</a></p>
      </div>
    </div>
  </div>
</section>

<!-- Contact Section -->
<section id="contact" class="cottage-section">
  <div class="cottage-container">
    <h2>Записаться на просмотр</h2>
    <p style="color: var(--text);">
      Оставьте контакты — мы перезвоним и договоримся об удобном времени.
    </p>
    <form class="cottage-form" id="contactForm">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
        <input class="cottage-input" type="text" name="name" placeholder="Имя" required />
        <input id="phone" class="cottage-input" type="tel" name="phone" required />
      </div>
      <input class="cottage-input" type="email" name="email" placeholder="Email (необязательно)" />
      <textarea class="cottage-textarea" name="comment" placeholder="Комментарий"></textarea>
      
      <!-- Privacy Consent -->
      <div style="margin: 1rem 0;">
        <label style="display: flex; align-items: flex-start; gap: 0.5rem; font-size: 0.9rem; color: var(--text); cursor: pointer;">
          <input type="checkbox" name="privacy_consent" required style="margin-top: 0.2rem; flex-shrink: 0;" />
          <span>
            Выражаю согласие на обработку моих персональных данных в соответствии с 
            <a href="privacy-policy.html" target="_blank" style="color: var(--accent); text-decoration: underline;">Политикой в отношении обработки персональных данных</a>
          </span>
        </label>
      </div>
      
      <!-- Marketing Consent -->
      <div style="margin: 1rem 0;">
        <label style="display: flex; align-items: flex-start; gap: 0.5rem; font-size: 0.9rem; color: var(--text); cursor: pointer;">
          <input type="checkbox" name="marketing_consent" style="margin-top: 0.2rem; flex-shrink: 0;" />
          <span>Я согласен (-на) на получение информационных и рекламных сообщений</span>
        </label>
      </div>

      <button class="cottage-btn cottage-btn--accent" type="submit">Отправить заявку</button>
    </form>
  </div>
</section>

<script>
const phoneInput = document.getElementById("phone");

// Маска телефона
window.addEventListener("DOMContentLoaded", () => {
  phoneInput.value = "+7 (";
});

phoneInput.addEventListener("input", function() {
  let value = phoneInput.value.replace(/\D/g, "");
  if (!value.startsWith("7")) value = "7" + value;
  let formatted = "+7 (";
  if (value.length > 1) formatted += value.substring(1,4);
  if (value.length >= 5) formatted += ") " + value.substring(4,7);
  if (value.length >= 8) formatted += "-" + value.substring(7,9);
  if (value.length >= 10) formatted += "-" + value.substring(9,11);
  phoneInput.value = formatted;
});

phoneInput.addEventListener("keydown", function(e) {
  if (phoneInput.selectionStart < 4 && (e.key === "Backspace" || e.key === "Delete")) e.preventDefault();
});

// Отправка формы на сервер
document.getElementById("contactForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const form = e.target;
  const data = {
    name: form.name.value,
    phone: form.phone.value,
    email: form.email.value,
    comment: form.comment.value
  };

  try {
    const res = await fetch("send_telegram.php", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(data)
    });
    const result = await res.json();
    if (result.ok) {
      alert("Заявка успешно отправлена!");
      form.reset();
      phoneInput.value = "+7 (";
    } else {
      alert("Ошибка при отправке. Попробуйте позже.");
    }
  } catch(err) {
    console.error(err);
    alert("Ошибка соединения.");
  }
});
</script>

</main>

  <!-- Footer -->
  <footer class="cottage-footer">
    <div class="cottage-container">
      <div style="display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap; margin-bottom: 2rem;">
        <div>© 2025 Исток. Все права защищены.</div>
        <div style="color: var(--muted);">ИП Назаренко В.В. • ИНН 301609702140 • ОГРНИП 324774600214546</div>
      </div>
      
      <!-- Legal Links -->
      <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; margin-bottom: 1rem;">
        <a href="privacy-policy.html" target="_blank" style="color: var(--accent); text-decoration: underline; font-size: 0.9rem;">
          Политика в отношении обработки персональных данных
        </a>
        <a href="privacy-consent.html" target="_blank" style="color: var(--accent); text-decoration: underline; font-size: 0.9rem;">
          Согласие на обработку персональных данных
        </a>
        <a href="cookie-policy.html" target="_blank" style="color: var(--accent); text-decoration: underline; font-size: 0.9rem;">
          Согласие на использование файлов cookie
        </a>
      </div>

<div style="text-align:center; font-size:0.9rem; color:var(--muted); margin-top:1rem;">
  Любая информация, представленная на данном сайте, носит исключительно информационный характер и ни при каких условиях не является публичной офертой, определяемой положениями статьи 437 ГК РФ. Отправляя сведения через любую электронную форму на данном сайте, вы даете свое согласие на обработку ваших персональных данных
</div>
</div> <!-- close .cottage-container -->

  </footer>

  <!-- Phone Button -->
  <a href="tel:+79859854352" class="phone-button" aria-label="Позвонить нам" title="Позвонить: +7 (985) 985-43-52">
    📞
  </a>

  <!-- Cookie Banner -->
  <div id="cookie-banner" class="cookie-banner">
    <div class="cookie-banner-content">
      <div>
        Продолжая использовать сайт, Вы даете ИП Назаренко В.В. (адрес: 115408, г. Москва, ул. Паромная улица, 7к3, кв 445, ИНН 301609702140, ОГРНИП 324774600214546) 
        согласие на использование файлов cookie на сайте Оператора и обработку пользовательских данных. 
        Если Вы не хотите, чтобы Ваши данные обрабатывались, просим отключить обработку файлов cookie и сбор пользовательских данных 
        в настройках Вашего браузера или покинуть сайт. 
        <a href="cookie-policy.html" target="_blank">Подробнее об использовании файлов cookie</a>
      </div>
      <button onclick="acceptCookies()">Принять</button>
    </div>
  </div>

   <script>
    // Sample data
    const plots = [
      {
        num: 1,
        area: 11.17,
        price: "502650.00",
        status: "Свободен",
        points: [
          { x: 0.848046875, y: 0.8987847222222223 },
          { x: 0.877734375, y: 0.8932291666666666 },
          { x: 0.880078125, y: 0.9446180555555556 },
          { x: 0.851171875, y: 0.9460069444444444 }
        ]
      }
    ];

    const lots = [
      { num: 1, area: 12.5, price: 585000, status: 'Свободен' },
      { num: 2, area: 10.8, price: 520000, status: 'Бронь' },
      { num: 3, area: 14.2, price: 640000, status: 'Продан' },
      { num: 4, area: 9.9, price: 490000, status: 'Свободен' },
      { num: 5, area: 15.3, price: 680000, status: 'Свободен' },
      { num: 6, area: 11.7, price: 535000, status: 'Бронь' }
    ];

    const houses = [
      {
        id: 1,
        title: "Дом «Родник»",
        description: "Уютный, как ключ у родного дома. Для молодой семьи или дачи.",
        area: 80,
        price: 6120000,
        images: [
          "house1-1.jpg",
          "house1-2.jpg",
          "house1-3.jpg",
          "house1-4.jpg"
        ]
      },
      {
        id: 2,
        title: "Дом «Очаг»",
        description: "Семейный, тёплый, с центром вокруг общего стола.",
        area: 100,
        price: 7778000,
        images: [
          "house2-1.jpg",
          "house2-2.jpg",
          "house2-3.jpg",
          "house2-4.jpg"
        ]
      },
      {
        id: 3,
        title: "Дом «Луговица»",
        description: "Светлый и спокойный, как поле летом.",
        area: 110,
        price: 8057300,
        images: [
          "house3-1.jpg",
          "house3-2.jpg",
          "house3-3.jpg",
          "house3-4.jpg"
        ]
      },
      {
        id: 4,
        title: "Дом «Усад»",
        description: "Традиционный и устойчивый, для тех, кто ценит уклад.",
        area: 120,
        price: 8677000,
        images: [
          "house4-1.jpg",
          "house4-2.jpg",
          "house4-3.jpg",
          "house4-4.jpg"
        ]
      },
      {
        id: 5,
        title: "Дом «Родовое древо»",
        description: "Для большой семьи и будущих поколений.",
        area: 170,
        price: 12489000,
        images: [
          "house5-1.jpg",
          "house5-2.jpg",
          "house5-3.jpg",
          "house5-4.jpg"
        ]
      }
    ];

    // Utility functions
    function formatPrice(num) {
      return new Intl.NumberFormat('ru-RU').format(num) + ' ₽';
    }

    function getStatusClass(status) {
      if (status === 'Свободен') return 'status status--free';
      if (status === 'Бронь') return 'status status--booked';
      return 'status status--sold';
    }

    // Populate lots
function populateLots() {
  const container = document.getElementById('lots-container');
  container.innerHTML = lots.map(lot => {
    // Рассчитаем цену со скидкой, например, 10%
    const discount = 0.1;
    const discountedPrice = Math.round(lot.price * (1 - discount));

    return `
      <article class="cottage-lot">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.6rem;">
          <strong>Участок №${lot.num}</strong>
          <span class="${getStatusClass(lot.status)}">${lot.status}</span>
        </div>
        <div style="color: var(--text); margin: 0.4rem 0 0.6rem;">
          Площадь: <b style="color: var(--text);">${lot.area} сот.</b>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: end;">
          <div>
            <div style="color: var(--text);">Цена</div>
            <div style="font-size: 1.1rem; font-weight: 700;">
              <span style="text-decoration: line-through; color: var(--text); margin-right: 0.5rem;">${formatPrice(lot.price)}</span>
              <span style="color: red;">${formatPrice(discountedPrice)}</span>
            </div>
          </div>
          <a class="cottage-btn" href="#contact">Забронировать</a>
        </div>
      </article>
    `;
  }).join('');
}

    // Populate houses
   function populateHouses() {
  const container = document.getElementById('houses-container');
  container.innerHTML = houses.map(house => `
    <article class="cottage-house-card">
      <div style="display: grid; grid-template-columns: 1fr 300px; gap: 1.5rem; align-items: start;">
        <div>
          <h3 style="margin: 0 0 0.5rem; font-size: 1.3rem; color: var(--text);">${house.title}</h3>
          <p style="color: var(--text); margin-bottom: 1rem;">${house.description}</p>
          
          <!-- Блок Площадь / Цена с классом -->
          <div class="house-info" style="margin-bottom: 1rem;">
            <div>
              <div style="color: var(--text); font-size: 0.9rem;">Площадь</div>
              <div style="font-weight: 600; color: var(--text);">${house.area} м²</div>
            </div>
            <div>
              <div style="color: var(--text); font-size: 0.9rem;">Цена</div>
              <div style="font-weight: 700; font-size: 1.2rem; color: var(--text);">${formatPrice(house.price)}</div>
            </div>
          </div>
          
          <a class="cottage-btn cottage-btn--accent" href="#contact">Получить консультацию</a>
        </div>
        <div>
          <div class="cottage-house-gallery" data-house-id="${house.id}">
            ${house.images.map((img, idx) => `<img src="${img}" alt="${house.title} - фото" data-index="${idx}" />`).join('')}
          </div>
        </div>
      </div>
    </article>
  `).join('');

  // Добавляем обработчики на каждую галерею отдельно
  document.querySelectorAll('.cottage-house-gallery').forEach(gallery => {
    const images = Array.from(gallery.querySelectorAll('img')).map(img => img.src);
    gallery.querySelectorAll('img').forEach(img => {
      img.addEventListener('click', e => {
        const index = parseInt(e.target.dataset.index);
        openLightbox(images, index);
      });
    });
  });
}

    // Master plan functionality
    const mapContainer = document.getElementById('map-container');
    const mapImg = document.getElementById('map-img');
    const svg = document.getElementById('map-svg');
    const tooltip = document.getElementById('tooltip');
    const filterNumInput = document.getElementById('filter-num');
    const filterAreaMinInput = document.getElementById('filter-area-min');
    const filterAreaMaxInput = document.getElementById('filter-area-max');
    const filterStatusSelect = document.getElementById('filter-status');

    function isTouchDevice() {
      return 'ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
    }

    function showTooltip(event, plot) {
      tooltip.style.display = 'block';
      tooltip.setAttribute('aria-hidden', 'false');
      tooltip.innerHTML = `
        <b>Участок №${plot.num}</b><br>
        Площадь: ${plot.area} сот.<br>
        Цена: ${Math.round(parseFloat(plot.price)).toLocaleString('ru-RU')} ₽<br>
        Статус: ${plot.status}
      `;
      moveTooltip(event);
    }

    function hideTooltip() {
      tooltip.style.display = 'none';
      tooltip.setAttribute('aria-hidden', 'true');
      tooltip.dataset.currentPlot = '';
    }

    function moveTooltip(event) {
      const containerRect = mapContainer.getBoundingClientRect();
      const tooltipRect = tooltip.getBoundingClientRect();
      const viewportWidth = window.innerWidth;

      let left = event.clientX - containerRect.left + 15;
      let top = event.clientY - containerRect.top + 15;

      if (left + tooltipRect.width > containerRect.width) {
        left = event.clientX - containerRect.left - tooltipRect.width - 15;
        if (left < 0) left = 0;
      }

      if (left + tooltipRect.width > viewportWidth) {
        left = viewportWidth - tooltipRect.width - 10;
        if (left < 0) left = 0;
      }

      if (top + tooltipRect.height > containerRect.height) {
        top = event.clientY - containerRect.top - tooltipRect.height - 15;
        if (top < 0) top = 0;
      }

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
    }

    function renderPlots() {
      svg.innerHTML = '';
      tooltip.style.display = 'none';
      tooltip.setAttribute('aria-hidden', 'true');
      tooltip.dataset.currentPlot = '';

      const filterNum = filterNumInput.value.trim();
      const filterStatus = filterStatusSelect.value;
      const filterAreaMin = parseFloat(filterAreaMinInput.value);
      const filterAreaMax = parseFloat(filterAreaMaxInput.value);

      const width = mapImg.clientWidth;
      const height = mapImg.clientHeight;
      svg.setAttribute('width', width);
      svg.setAttribute('height', height);

      plots.forEach(plot => {
        if (filterNum && String(plot.num) !== filterNum) return;
        if (filterStatus && plot.status !== filterStatus) return;
        if (!isNaN(filterAreaMin) && plot.area < filterAreaMin) return;
        if (!isNaN(filterAreaMax) && plot.area > filterAreaMax) return;

        const pointsStr = plot.points.map(p => `${p.x * width},${p.y * height}`).join(' ');

        const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        polygon.setAttribute('points', pointsStr);
        polygon.classList.add('status-' + plot.status);
        polygon.setAttribute('tabindex', 0);
        polygon.setAttribute('aria-label', `Участок №${plot.num}, площадь ${plot.area} соток, цена ${plot.price} рублей, статус ${plot.status}`);

        polygon.addEventListener('mouseenter', e => { if (!isTouchDevice()) showTooltip(e, plot); });
        polygon.addEventListener('mousemove', e => { if (!isTouchDevice()) moveTooltip(e); });
        polygon.addEventListener('mouseleave', e => { if (!isTouchDevice()) hideTooltip(); });
        polygon.addEventListener('click', e => {
          if (isTouchDevice()) {
            if (tooltip.style.display === 'block' && tooltip.dataset.currentPlot == plot.num) {
              hideTooltip();
            } else {
              showTooltip(e, plot);
              tooltip.dataset.currentPlot = plot.num;
            }
          }
        });

        svg.appendChild(polygon);
      });
    }

    function applyFilters() {
      renderPlots();
    }

    function resetFilters() {
      filterNumInput.value = '';
      filterStatusSelect.value = '';
      filterAreaMinInput.value = '';
      filterAreaMaxInput.value = '';
      renderPlots();
    }

    // Cookie Banner
    function showCookieBanner() {
      if (!localStorage.getItem('cookieConsent')) {
        document.getElementById('cookie-banner').classList.add('show');
      }
    }

    function acceptCookies() {
      localStorage.setItem('cookieConsent', 'accepted');
      document.getElementById('cookie-banner').classList.remove('show');
    }

    function submitForm(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      
      // Check privacy consent
      if (!formData.get('privacy_consent')) {
        alert('Необходимо дать согласие на обработку персональных данных для отправки заявки.');
        return;
      }
      
      // Here you would normally send the data to your server
      console.log('Form submitted:', Object.fromEntries(formData.entries()));
      
      alert('Спасибо за заявку! Мы свяжемся с вами в ближайшее время.');
      form.reset();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      populateLots();
      populateHouses();
      
      mapImg.addEventListener('load', renderPlots);
      if (mapImg.complete) {
        renderPlots();
      }
      window.addEventListener('resize', renderPlots);

      // Show cookie banner after a delay
      setTimeout(showCookieBanner, 1000);

      // --- Mobile menu (burger) ---
      const burger = document.getElementById('burger');
      const mobileMenu = document.getElementById('mobileMenu');
      const menuOverlay = document.getElementById('menuOverlay');

      function openMenu(){
        mobileMenu?.classList.add('show');
        menuOverlay?.classList.add('show');
        document.body.classList.add('no-scroll');
        burger?.setAttribute('aria-expanded','true');
      }
      function closeMenu(){
        mobileMenu?.classList.remove('show');
        menuOverlay?.classList.remove('show');
        document.body.classList.remove('no-scroll');
        burger?.setAttribute('aria-expanded','false');
      }

      burger?.addEventListener('click', (e) => {
        e.stopPropagation();
        if (mobileMenu?.classList.contains('show')) { closeMenu(); } else { openMenu(); }
      });
      menuOverlay?.addEventListener('click', closeMenu);
      mobileMenu?.querySelectorAll('a').forEach(a => a.addEventListener('click', closeMenu));
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });
    });
  
function openLightbox(images, startIndex) {
  let index = startIndex;
  const viewer = document.createElement('div');
  viewer.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:9999;';
  
  const img = document.createElement('img');
  img.src = images[index];
  img.style.maxWidth = '90%';
  img.style.maxHeight = '90%';
  viewer.appendChild(img);
  
  const prev = document.createElement('div');
  prev.innerHTML = '&#10094;';
  prev.style.cssText = 'position:absolute;left:20px;color:white;font-size:3rem;cursor:pointer;user-select:none;';
  prev.onclick = e => { e.stopPropagation(); index = (index - 1 + images.length) % images.length; img.src = images[index]; };
  
  const next = document.createElement('div');
  next.innerHTML = '&#10095;';
  next.style.cssText = 'position:absolute;right:20px;color:white;font-size:3rem;cursor:pointer;user-select:none;';
  next.onclick = e => { e.stopPropagation(); index = (index + 1) % images.length; img.src = images[index]; };
  
  viewer.appendChild(prev);
  viewer.appendChild(next);
  viewer.onclick = () => document.body.removeChild(viewer);
  document.body.appendChild(viewer);
}

document.querySelectorAll('.cottage-gallery img').forEach((img, idx) => {
  img.addEventListener('click', () => {
    const srcs = Array.from(document.querySelectorAll('.cottage-gallery img')).map(i => i.src);
    openLightbox(srcs, idx);
  });
});

document.querySelectorAll('.cottage-house-gallery img').forEach((img, idx) => {
  img.addEventListener('click', () => {
    const srcs = Array.from(document.querySelectorAll('.cottage-house-gallery img')).map(i => i.src);
    openLightbox(srcs, idx);
  });
});


</script>

<script>
// === Genplan Fullscreen Viewer (image + SVG polygons + tooltips + pan/zoom/pinch) ===
(function(){
  const triggerImg  = document.getElementById('map-img');
  const triggerBox  = document.getElementById('map-container');
  if(!triggerImg || !triggerBox) return;

  function isTouch(){ return ('ontouchstart' in window) || navigator.maxTouchPoints > 0; }

  // Get current filters from the inline controls (if present)
  const numInput   = document.getElementById('filter-num');
  const areaMinInp = document.getElementById('filter-area-min');
  const areaMaxInp = document.getElementById('filter-area-max');
  const statusSel  = document.getElementById('filter-status');

  function getFilteredPlots() {
    try {
      const filterNum = (numInput && numInput.value.trim()) || '';
      const filterStatus = (statusSel && statusSel.value) || '';
      const filterAreaMin = areaMinInp && areaMinInp.value ? parseFloat(areaMinInp.value) : NaN;
      const filterAreaMax = areaMaxInp && areaMaxInp.value ? parseFloat(areaMaxInp.value) : NaN;

      return (window.plots || []).filter(plot => {
        if (filterNum && String(plot.num) !== filterNum) return false;
        if (filterStatus && plot.status !== filterStatus) return false;
        if (!isNaN(filterAreaMin) && plot.area < filterAreaMin) return false;
        if (!isNaN(filterAreaMax) && plot.area > filterAreaMax) return false;
        return true;
      });
    } catch(e){
      return (window.plots || []);
    }
  }

  function openViewer(){
    // build DOM
    const overlay  = document.createElement('div');
    overlay.className = 'genplan-viewer gp-overlay';
    overlay.setAttribute('role','dialog');
    overlay.setAttribute('aria-modal','true');

    const stage = document.createElement('div');
    stage.className = 'gp-stage';
    overlay.appendChild(stage);

    // toolbar
    const toolbar = document.createElement('div');
    toolbar.className = 'gp-toolbar';
    toolbar.innerHTML = '<button class="gp-btn" data-act="zin">+</button>' +
                        '<button class="gp-btn" data-act="zout">−</button>' +
                        '<button class="gp-btn" data-act="fit">По центру</button>' +
                        '<button class="gp-btn" data-act="close">Закрыть ✕</button>';
    overlay.appendChild(toolbar);
    // ensure close button works on first click and doesn't re-open due to bubbling
    const closeBtn = toolbar.querySelector('[data-act="close"]');
    if (closeBtn) {
      const kill = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        cleanup();
      };
      closeBtn.addEventListener('click', kill);
      closeBtn.addEventListener('pointerup', kill);
    }


    // content (image + svg overlay) inside a single transformable wrapper
    const content = document.createElement('div');
    content.className = 'gp-content';
    stage.appendChild(content);

    const img = document.createElement('img');
    img.className = 'gp-img';
    img.alt = 'Генеральный план поселка';
    img.src = triggerImg.currentSrc || triggerImg.src;
    content.appendChild(img);

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.classList.add('gp-svg');
    content.appendChild(svg);

    const tip = document.createElement('div');
    tip.className = 'gp-tooltip';
    stage.appendChild(tip);

    document.body.appendChild(overlay);
    document.body.style.overflow = 'hidden';

    // state
    let scale = 1, minScale = 1, maxScale = 8;
    let tx = 0, ty = 0;
    let dragging = false, lastX = 0, lastY = 0;
    let touchMode = null, lastDist = 0;

    // helpers
    function applyTransform(){
      content.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
    }
    function fitToScreen(){
      const rect = stage.getBoundingClientRect();
      const iw = img.naturalWidth;
      const ih = img.naturalHeight;
      // content base size is natural image size
      content.style.width = iw + 'px';
      content.style.height = ih + 'px';
      img.style.width = iw + 'px';
      img.style.height = ih + 'px';
      svg.setAttribute('width', iw);
      svg.setAttribute('height', ih);
      svg.setAttribute('viewBox', `0 0 ${iw} ${ih}`);

      const kx = rect.width / iw;
      const ky = rect.height / ih;
      minScale = Math.min(kx, ky);
      // leave a small margin
      minScale = Math.min(minScale, 1); // don't upscale on desktop initial
      if (minScale > 1) minScale = 1;
      scale = minScale; // open at fit-to-screen scale, avoids initial zoom-in on mobile
      tx = (rect.width - iw * scale) * 0.5;
      ty = (rect.height - ih * scale) * 0.5;
      applyTransform();
    }

    function showTipAtScreen(x, y, html){
      tip.innerHTML = html;
      tip.style.display = 'block';
      // shift so tip doesn't hide under finger
      const pad = 14;
      let left = x + pad;
      let top  = y + pad;
      const tr = tip.getBoundingClientRect();
      const sr = stage.getBoundingClientRect();
      if (left + tr.width > sr.right)  left = x - tr.width - pad;
      if (top + tr.height > sr.bottom) top = y - tr.height - pad;
      if (left < sr.left) left = sr.left + 8;
      if (top < sr.top)   top  = sr.top + 8;
      tip.style.left = (left - sr.left) + 'px';
      tip.style.top  = (top - sr.top) + 'px';
    }
    function hideTip(){ tip.style.display = 'none'; tip.innerHTML=''; }

    function plotTooltipHTML(plot){
      const price = (plot.price && !isNaN(parseFloat(plot.price))) ?
        Math.round(parseFloat(plot.price)).toLocaleString('ru-RU') + ' ₽' : plot.price;
      return `<b>Участок №${plot.num}</b><br>Площадь: ${plot.area} сот.<br>Цена: ${price}<br>Статус: ${plot.status}`;
    }

    function drawPolygons(){
      while (svg.firstChild) svg.removeChild(svg.firstChild);
      const iw = img.naturalWidth, ih = img.naturalHeight;
      const list = getFilteredPlots();
      list.forEach(plot => {
        const pts = (plot.points || []).map(p => `${p.x*iw},${p.y*ih}`).join(' ');
        const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        poly.setAttribute('points', pts); poly.setAttribute('data-num', plot.num);
        poly.setAttribute('tabindex', 0);
        poly.classList.add('status-' + (plot.status || 'Свободен'));
        // hover/move
        poly.addEventListener('mouseenter', e => {
          if(isTouch()) return;
          const r = stage.getBoundingClientRect();
          showTipAtScreen(e.clientX, e.clientY, plotTooltipHTML(plot));
        });
        poly.addEventListener('mousemove', e => {
          if(isTouch()) return;
          showTipAtScreen(e.clientX, e.clientY, plotTooltipHTML(plot));
        });
        poly.addEventListener('mouseleave', () => { if(!isTouch()) hideTip(); });
        // click/tap -> show near polygon centroid
        poly.addEventListener('click', (e) => {
          e.stopPropagation();
          // centroid in image coords
          const pts2 = (plot.points || []);
          const cx = pts2.reduce((s,p)=>s+p.x,0)/pts2.length * img.naturalWidth;
          const cy = pts2.reduce((s,p)=>s+p.y,0)/pts2.length * img.naturalHeight;
          // map to screen coords with current transform
          const sr = stage.getBoundingClientRect();
          const sx = sr.left + tx + cx*scale;
          const sy = sr.top  + ty + cy*scale;
          showTipAtScreen(sx, sy, plotTooltipHTML(plot));
        });
        svg.appendChild(poly);
      });
    }

    // events
    toolbar.addEventListener('click', (e) => {
      const act = e.target && e.target.getAttribute('data-act');
      if(!act) return;
      if (act === 'close'){ cleanup(); return; }
      if (act === 'fit'){ fitToScreen(); hideTip(); return; }
      const rect = stage.getBoundingClientRect();
      const cx = rect.width/2, cy = rect.height/2;
      if (act === 'zin' || act === 'zout') {
        const prev = scale;
        let ns = prev * (act === 'zin' ? 1.2 : 1/1.2);
        ns = Math.max(minScale, Math.min(maxScale, ns));
        const k = ns / prev;
        tx = cx - (cx - tx) * k;
        ty = cy - (cy - ty) * k;
        scale = ns;
        applyTransform();
      }
    });

    // drag/pan (mouse)
    stage.addEventListener('mousedown', (e) => {
      dragging = true; lastX = e.clientX; lastY = e.clientY; stage.style.cursor = 'grabbing'; hideTip();
    });
    window.addEventListener('mousemove', (e) => {
      if(!dragging) return;
      tx += e.clientX - lastX; ty += e.clientY - lastY; lastX = e.clientX; lastY = e.clientY;
      applyTransform();
    });
    window.addEventListener('mouseup', () => { dragging = false; stage.style.cursor = 'grab'; });

    // wheel zoom
    stage.addEventListener('wheel', (e) => {
      e.preventDefault();
      const rect = stage.getBoundingClientRect();
      const cx = e.clientX - rect.left;
      const cy = e.clientY - rect.top;
      const prev = scale;
      let ns = prev * (e.deltaY < 0 ? 1.15 : 1/1.15);
      ns = Math.max(minScale, Math.min(maxScale, ns));
      const k = ns / prev;
      tx = cx - (cx - tx) * k;
      ty = cy - (cy - ty) * k;
      scale = ns;
      applyTransform();
    }, { passive:false });

    // touch: pan + pinch
    stage.addEventListener('touchstart', (e) => {
      if(e.touches.length === 1){ touchMode = 'pan'; const t = e.touches[0]; lastX=t.clientX; lastY=t.clientY; hideTip(); }
      else if(e.touches.length === 2){ touchMode = 'pinch';
        const [t1,t2] = e.touches; lastDist = Math.hypot(t2.clientX-t1.clientX, t2.clientY-t1.clientY);
      }
    }, { passive:true });

    stage.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (touchMode === 'pan' && e.touches.length === 1){
        const t = e.touches[0];
        tx += t.clientX - lastX; ty += t.clientY - lastY; lastX=t.clientX; lastY=t.clientY; applyTransform();
      } else if (touchMode === 'pinch' && e.touches.length === 2){
        const [t1,t2] = e.touches;
        const dist = Math.hypot(t2.clientX-t1.clientX, t2.clientY-t1.clientY);
        const rect = stage.getBoundingClientRect();
        const cx = (t1.clientX+t2.clientX)*0.5 - rect.left;
        const cy = (t1.clientY+t2.clientY)*0.5 - rect.top;
        const prev = scale;
        let ns = Math.max(minScale, Math.min(maxScale, scale*(dist/lastDist)));
        const k = ns/prev;
        tx = cx - (cx - tx) * k; ty = cy - (cy - ty) * k; scale = ns; lastDist = dist; applyTransform();
      }
    }, { passive:false });
    stage.addEventListener('touchend', () => { touchMode = null; }, { passive:true });

    // close on Esc, and on background click (outside content)
    function onKey(e){ if(e.key === 'Escape') cleanup(); }
    window.addEventListener('keydown', onKey);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) cleanup(); });

    function cleanup(){
      document.body.style.overflow = '';
      window.removeEventListener('keydown', onKey);
      overlay.remove();
    }

    // init once image is ready
    function afterImg(){
      fitToScreen();
      drawPolygons();
      applyTransform();
    }
    if (img.complete && img.naturalWidth) { afterImg(); }
    else { img.addEventListener('load', afterImg); }
  }

  window.openGenplanViewer = openViewer;
  // open on click both on image and on container (to be safe on different CSS states)
  triggerImg.addEventListener('click', openViewer);
  triggerBox.addEventListener('click', (e)=>{
    // ignore clicks on inline filters or external controls
    if (e.target.closest('input,select,button,.master-plan-legend')) return;
    openViewer();
  });
})();
</script>



<script>
// === Robust open binding (capture phase + transparent hotspot) ===
(function(){
  function ready(fn){ if(document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    const box = document.getElementById('map-container');
    const img = document.getElementById('map-img');
    if (!box || !img) return;

    // Transparent hotspot to ensure any click opens fullscreen (unless clicking UI controls)
    let hotspot = box.querySelector('.gp-open-hotspot');
    if (!hotspot) {
      hotspot = document.createElement('button');
      hotspot.className = 'gp-open-hotspot';
      hotspot.setAttribute('type','button');
      hotspot.setAttribute('aria-label','Открыть генплан на весь экран');
      box.appendChild(hotspot);
    }

    // guard to avoid double opens
    function isOverlayOpen(){ return !!document.querySelector('.genplan-viewer.gp-overlay'); }

    // click on hotspot opens
    hotspot.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      if (isOverlayOpen()) return;
      // trigger the viewer if the function from the other script is present
      try {
        const clickEvt = new Event('click', { bubbles:true });
        if (window.openGenplanViewer) { window.openGenplanViewer(); } else { img.dispatchEvent(clickEvt); }
      } catch(err){}
    });

    // Capture-phase fallback: any click inside map-container opens, unless it's on controls
    document.addEventListener('click', function(e){
      const target = e.target;
      if (!box.contains(target)) return;
      if (target.closest('input,select,button,.master-plan-legend,.filters')) return;
      if (isOverlayOpen()) return;
      try {
        const clickEvt = new Event('click', { bubbles:true });
        if (window.openGenplanViewer) { window.openGenplanViewer(); } else { img.dispatchEvent(clickEvt); }
      } catch(err){}
    }, true);
  });
})();
</script>


<script>
// === Inline Genplan Tooltip (outside fullscreen) ===
(function(){
  function ready(fn){ if(document.readyState!='loading') fn(); else document.addEventListener('DOMContentLoaded',fn); }
  ready(function(){
    const box = document.getElementById('map-container');
    const img = document.getElementById('map-img');
    if (!box || !img || !(window.plots && window.plots.length)) return;

    // create svg overlay inside map-container if not present
    let svg = box.querySelector('svg.gp-svg');
    if(!svg){
      svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.classList.add('gp-svg');
      box.appendChild(svg);
    }

    // create tooltip element
    let tip = box.querySelector('.gp-tooltip');
    if(!tip){
      tip = document.createElement('div');
      tip.className = 'gp-tooltip';
      box.appendChild(tip);
    }

    function hideTip(){ tip.style.display='none'; tip.innerHTML=''; }
    function showTipAt(x,y,html){
      tip.innerHTML=html; tip.style.display='block';
      const pad=10;
      let left=x+pad, top=y+pad;
      const br=box.getBoundingClientRect(), tr=tip.getBoundingClientRect();
      if(left+tr.width>br.right) left=x-tr.width-pad;
      if(top+tr.height>br.bottom) top=y-tr.height-pad;
      tip.style.left=(left-br.left)+'px'; tip.style.top=(top-br.top)+'px';
    }

    function plotTooltipHTML(plot){
      const price = (plot.price && !isNaN(parseFloat(plot.price))) ?
        Math.round(parseFloat(plot.price)).toLocaleString('ru-RU') + ' ₽' : plot.price;
      return `<b>Участок №${plot.num}</b><br>Площадь: ${plot.area} сот.<br>Цена: ${price}<br>Статус: ${plot.status}`;
    }

    function drawPolygons(){
      while(svg.firstChild) svg.removeChild(svg.firstChild);
      const iw=img.naturalWidth, ih=img.naturalHeight;
      svg.setAttribute('viewBox', `0 0 ${iw} ${ih}`);
      svg.setAttribute('width', img.clientWidth);
      svg.setAttribute('height', img.clientHeight);
      window.plots.forEach(plot=>{
        const pts=(plot.points||[]).map(p=>`${p.x*iw},${p.y*ih}`).join(' ');
        const poly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
        poly.setAttribute('points', pts); poly.setAttribute('data-num', plot.num);
        poly.classList.add('status-'+(plot.status||'Свободен'));
        poly.addEventListener('mouseenter', e=>{
          if(('ontouchstart' in window)) return;
          showTipAt(e.clientX,e.clientY,plotTooltipHTML(plot));
        });
        poly.addEventListener('mousemove', e=>{
          if(('ontouchstart' in window)) return;
          showTipAt(e.clientX,e.clientY,plotTooltipHTML(plot));
        });
        poly.addEventListener('mouseleave', hideTip);
        poly.addEventListener('click', e=>{
          e.stopPropagation();
          const r=box.getBoundingClientRect();
          showTipAt(e.clientX,e.clientY,plotTooltipHTML(plot));
        });
        svg.appendChild(poly);
      });
    }

    if(img.complete && img.naturalWidth){ drawPolygons(); }
    else img.addEventListener('load', drawPolygons);

    box.addEventListener('click', e=>{
      if(e.target.tagName!=='polygon') hideTip();
    });
  });
})();
</script>


<script>
// Ensure window.plots is set after all scripts (fallback if plots was declared later with const/let)
(function(){
  function ensure() {
    try {
      if (typeof plots !== 'undefined' && !window.plots) window.plots = plots;
      if (typeof lots !== 'undefined' && !window.lots) window.lots = lots;
    } catch(e){}
  }
  // Try immediately (in case this script runs after plots)
  ensure();
  // Also try again on DOMContentLoaded (if plots declared later)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensure);
  }
  // Also try again after a short delay to catch late-inline scripts
  setTimeout(ensure, 500);
})();
</script>


<script>
// Delegation: intercept clicks on inline polygons and open overlay with that plot.
// Also keep #map-container height matched to image (mobile whitespace fix).
(function(){
  function init(){
    const box = document.getElementById('map-container');
    const img = document.getElementById('map-img');
    if (!box || !img) return;

    function hideInlineTip(){ const t = box.querySelector('.gp-tooltip'); if (t){ t.style.display='none'; t.innerHTML=''; } }

    function handleClickOnPoly(e){
      const poly = e.target.closest('polygon');
      if (!poly) return;
      e.stopPropagation(); e.preventDefault();
      hideInlineTip();
      const id = poly.getAttribute('data-num') || poly.dataset.num;
      const plot = (window.plots || []).find(p => String(p.num) === String(id));
      if (window.openGenplanViewer) {
        try { window.openGenplanViewer(plot || id); return; } catch(err){ /* continue to fallback */ }
      }
      // fallback: trigger image click which opens viewer
      const clickEvt = new Event('click', { bubbles:true });
      img.dispatchEvent(clickEvt);
    }

    // attach delegation on the inline svg (it may be created later)
    function attachOnce(){
      const svg = box.querySelector('svg.gp-svg');
      if (!svg) { return false; }
      // ensure svg will receive pointer events for polygons
      svg.style.pointerEvents = 'auto';
      svg.addEventListener('click', handleClickOnPoly, true);
      return true;
    }

    // try attach now or poll shortly
    if (!attachOnce()){
      let tries = 0;
      const t = setInterval(()=>{
        tries++;
        if (attachOnce() || tries>30) clearInterval(t);
      }, 150);
    }

    // ensure container has exact image height to avoid extra space under map on mobile
    function updateContainerSize(){
      box.style.display = 'inline-block';
      box.style.lineHeight = '0';
      if (img.clientHeight) box.style.height = img.clientHeight + 'px';
    }
    if (img.complete) updateContainerSize(); else img.addEventListener('load', updateContainerSize);
    window.addEventListener('resize', updateContainerSize);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>


<script>
// Wrapper for window.openGenplanViewer that accepts an initial plot/ID and ensures only one tooltip is shown.
// It opens the overlay (via original), then polls for the matching polygon inside the overlay and triggers one click on it.
(function(){
  // wait until the original opener exists
  function wrap(){
    if (!window.openGenplanViewer) { return false; }
    const orig = window.openGenplanViewer;
    window.openGenplanViewer = function(initialPlot){
      // hide inline tooltip if any
      const inlineTip = document.querySelector('#map-container .gp-tooltip');
      if (inlineTip){ inlineTip.style.display='none'; inlineTip.innerHTML=''; }

      // if overlay already present, try to show plot inside it
      const existing = document.querySelector('.genplan-viewer.gp-overlay');
      const id = (initialPlot && (initialPlot.num || initialPlot)) || initialPlot;
      if (existing){
        const svg = existing.querySelector('.gp-svg');
        if (svg) {
          const poly = svg.querySelector('polygon[data-num="'+id+'"]');
          if (poly) { poly.dispatchEvent(new MouseEvent('click',{bubbles:true})); return; }
        }
      }

      // call original opener to create overlay
      try { orig(); } catch(e) { /* ignore */ }

      if (typeof id === 'undefined' || id === null) return;

      // poll for polygon in overlay then dispatch a single click to open its tooltip (overlay handles dedup)
      let tries = 0;
      const timer = setInterval(function(){
        tries++;
        const overlay = document.querySelector('.genplan-viewer.gp-overlay');
        if (!overlay) { if (tries>30) clearInterval(timer); return; }
        const svg = overlay.querySelector('.gp-svg');
        if (!svg) { if (tries>30) clearInterval(timer); return; }
        const poly = svg.querySelector('polygon[data-num="'+id+'"]') || svg.querySelector('polygon');
        if (poly){
          // ensure overlay's tip is hidden first
          const otip = overlay.querySelector('.gp-tooltip');
          if (otip){ otip.style.display='none'; otip.innerHTML=''; }
          poly.dispatchEvent(new MouseEvent('click',{bubbles:true}));
          clearInterval(timer);
        }
        if (tries>30) clearInterval(timer);
      }, 100);
    };
    return true;
  }

  if (!wrap()){
    document.addEventListener('DOMContentLoaded', function(){ wrap(); });
    setTimeout(wrap, 500);
  }
})();
</script>

</body>
</html>
